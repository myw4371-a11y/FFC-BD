<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Wallet</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .tab-container {
            display: flex;
            background: #333;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #252525;
            color: #aaa;
            font-weight: bold;
        }
        .tab.active {
            background: #ff9800;
            color: white;
        }
        .form-box {
            padding: 20px;
            display: none; /* Hidden by default */
        }
        .form-box.active {
            display: block;
        }
        .copy-box {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            border: 1px dashed #666;
        }
        .admin-note {
            background: #2a2a2a;
            padding: 10px;
            font-size: 12px;
            color: #ccc;
            border-left: 3px solid #ff9800;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div style="background: #222; padding: 15px; display: flex; align-items: center;">
            <i class="fas fa-arrow-left back-btn" style="cursor:pointer" onclick="history.back()"></i>
            <h3 style="margin-left: 10px;">Wallet</h3>
        </div>

        <div class="tab-container">
            <div class="tab active" onclick="switchTab('add')">‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</div>
            <div class="tab" onclick="switchTab('withdraw')">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</div>
        </div>

        <div id="add-section" class="form-box active">
            <h3>Add Money</h3>
            
            <div class="input-group">
                <label>‡¶Æ‡ßá‡¶•‡¶° ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                <select id="addMethod" class="btn-primary" style="background:#333; border:1px solid #555;">
                    <option value="Bkash">Bkash (Send Money)</option>
                    <option value="Nagad">Nagad (Send Money)</option>
                </select>
            </div>

            <div class="copy-box">
                <span id="adminNumber">01xxxxxxxxx</span>
                <i class="far fa-copy" style="cursor:pointer; color:#ff9800;" onclick="copyNumber()"></i>
            </div>
            <small style="color: #888;">‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡¶ü‡¶ø ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßá ‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</small>

            <div class="input-group" style="margin-top: 15px;">
                <label>Transaction ID (TrxID)</label>
                <input type="text" id="trxID" placeholder="TrxID ‡¶¨‡¶∏‡¶æ‡¶®">
            </div>

            <div class="input-group">
                <label>‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</label>
                <input type="number" id="addAmount" placeholder="‡¶ï‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡¶æ‡¶†‡¶ø‡ßü‡ßá‡¶õ‡ßá‡¶®?">
            </div>

            <button class="btn-primary" onclick="submitAddRequest()">‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>

            <div class="admin-note" id="addNote">
                ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶®‡¶ø‡ßü‡¶Æ‡¶æ‡¶¨‡¶≤‡ßÄ...
            </div>
        </div>

        <div id="withdraw-section" class="form-box">
            <h3>Withdraw Money</h3>
            
            <div class="input-group">
                <label>‡¶ï‡ßã‡¶•‡¶æ‡ßü ‡¶®‡¶ø‡¶¨‡ßá‡¶®?</label>
                <select id="withMethod" class="btn-primary" style="background:#333; border:1px solid #555;">
                    <option value="Bkash">Bkash</option>
                    <option value="Nagad">Nagad</option>
                </select>
            </div>

            <div class="input-group">
                <label>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞</label>
                <input type="number" id="withNumber" placeholder="01xxxxxxxxx">
            </div>

            <div class="input-group">
                <label>‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</label>
                <input type="number" id="withAmount" placeholder="Min: 50 BDT">
            </div>

            <button class="btn-primary" onclick="submitWithdraw()">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</button>

            <div class="admin-note" id="withNote">
                ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶®‡¶ø‡ßü‡¶Æ‡¶æ‡¶¨‡¶≤‡ßÄ...
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { firebaseConfig, telegramConfig } from '../js/config.js';

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const uid = localStorage.getItem('uid');
        const username = localStorage.getItem('username');

        // Load Admin Info (Numbers & Notes)
        onValue(ref(db, 'adminInfo'), (snapshot) => {
            const data = snapshot.val();
            if(data) {
                document.getElementById('adminNumber').innerText = data.bkashNumber || "No Number";
                document.getElementById('addNote').innerText = data.addNote || "Admin will verify.";
                document.getElementById('withNote').innerText = data.withdrawNote || "Wait 24 hours.";
            }
        });

        // 1. Submit Add Money Request
        window.submitAddRequest = () => {
            const method = document.getElementById('addMethod').value;
            const trx = document.getElementById('trxID').value;
            const amount = document.getElementById('addAmount').value;

            if(!trx || !amount) return alert("‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®!");

            // Send to Telegram
            const text = `üí∞ <b>Add Money Request</b>\n\nüë§ User: ${username}\nüì± Method: ${method}\nüÜî TrxID: ${trx}\nüíµ Amount: ${amount}`;
            sendTelegram(text);

            alert("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶π‡¶¨‡ßá‡•§");
            window.location.href = 'home.html';
        };

        // 2. Submit Withdraw Request
        window.submitWithdraw = async () => {
            const method = document.getElementById('withMethod').value;
            const number = document.getElementById('withNumber').value;
            const amount = parseInt(document.getElementById('withAmount').value);

            if(!number || !amount) return alert("‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®!");

            // Check Balance Logic
            const userRef = ref(db, 'users/' + uid);
            
            try {
                await runTransaction(userRef, (userData) => {
                    if (userData) {
                        if (userData.balance >= amount) {
                            userData.balance -= amount; // Deduct balance instantly
                            return userData;
                        } else {
                            throw new Error("low_balance");
                        }
                    }
                    return userData;
                });

                // Send to Telegram
                const text = `üí∏ <b>Withdraw Request</b>\n\nüë§ User: ${username}\nüì± Method: ${method}\nüìû Number: ${number}\nüíµ Amount: ${amount}`;
                sendTelegram(text);

                alert("‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶∏‡¶´‡¶≤! ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßá ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßá‡¶®‡•§");
                window.location.href = 'home.html';

            } catch (error) {
                if(error.message === 'low_balance') alert("‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶®‡ßá‡¶á!");
                else console.error(error);
            }
        };

        // Helper: Telegram Sender
        function sendTelegram(text) {
            const token = telegramConfig.botToken;
            const chat_id = telegramConfig.chatId;
            fetch(`https://api.telegram.org/bot${token}/sendMessage?chat_id=${chat_id}&text=${encodeURIComponent(text)}&parse_mode=HTML`);
        }

        // Helper: Copy Number
        window.copyNumber = () => {
            const num = document.getElementById('adminNumber').innerText;
            navigator.clipboard.writeText(num);
            alert("‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        }

        // Helper: Tab Switch
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.form-box').forEach(f => f.classList.remove('active'));

            if(tab === 'add') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('add-section').classList.add('active');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('withdraw-section').classList.add('active');
            }
        }
    </script>
</body>
</html>
